# Swagger Implementation ‚Äì Current State Analysis

## üìä Xulosa

Bu hujjat loyihaning Swagger/OpenAPI dokumentatsionasining joriy holati, mavjud patterns, va shared modules'ga o'tkazish uchun tahlillarni o'z ichiga oladi.

---

## 1Ô∏è‚É£ Mavjud Swagger Setup'lari

### 1.1 Agent API

**üìç Fayl:** `apps/agent-api/src/main.ts`

```typescript
const config = new DocumentBuilder()
    .setTitle('Staff Control System - Agent API')
    .setDescription('Data collection API for computer monitoring and access control systems')
    .setVersion('1.0')
    .addApiKey({ type: 'apiKey', name: 'X-API-Key', in: 'header' }, 'api-key')
    .addBearerAuth()
    .addTag('Agent', 'Computer monitoring data collection')
    .addTag('HIKVision', 'HIKVision access control integration')
    .addTag('Data Processing', 'Asynchronous data processing')
    .addTag('Security', 'API security management')
    .build();

const document = SwaggerModule.createDocument(app, config);
SwaggerModule.setup('api/docs', app, document);
```

**Status:**
- ‚úÖ DocumentBuilder configured
- ‚úÖ Tags defined
- ‚úÖ API key + Bearer auth supported
- ‚ùå Controllers largely undocumented
- ‚ùå No extraModels configured

**Swagger URL:** `http://localhost:3001/api/docs`

---

### 1.2 Dashboard API

**üìç Fayl:** `apps/dashboard-api/src/main.ts`

```typescript
const config = new DocumentBuilder()
    .setTitle('Staff Control System - Dashboard API')
    .setDescription('Comprehensive API for staff management, monitoring, and reporting')
    .setVersion('1.0')
    .addBearerAuth()
    .addTag('Authentication', 'User authentication and authorization')
    .addTag('Users', 'User management operations')
    .addTag('Organizations', 'Organization management')
    .addTag('Departments', 'Department management')
    .addTag('Employees', 'Employee management')
    .addTag('Visitors', 'Visitor management and access control')
    .addTag('Policies', 'Security and monitoring policies')
    .build();

const document = SwaggerModule.createDocument(app, config, {
    extraModels: [ApiSuccessResponse, ApiErrorResponse, ApiPaginatedResponse],
});

SwaggerModule.setup('api/docs', app, document, {
    jsonDocumentUrl: 'api/docs-json',
    customSiteTitle: 'Sector Staff API Docs',
});
```

**Status:**
- ‚úÖ DocumentBuilder configured
- ‚úÖ Tags defined (7 tags)
- ‚úÖ extraModels configured
- ‚úÖ Custom Swagger UI options
- ‚ö†Ô∏è Controllers dokumentatsiyasi partial (User ‚úÖ, others ‚ùå)

**Swagger URL:** `http://localhost:3000/api/docs`

---

### 1.3 Agent Gateway

**üìç Fayl:** `apps/agent-gateway/src/main.ts`

```typescript
async function bootstrap() {
    const app = await NestFactory.create(AppModule, { bufferLogs: true });
    app.setGlobalPrefix('v1');
    app.useGlobalPipes(
        new ValidationPipe({
            whitelist: true,
            transform: true,
        })
    );

    const port = Number(process.env.PORT) || 4100;
    await app.listen(port, '0.0.0.0');
    Logger.log(`Agent Gateway listening on http://localhost:${port}/v1/health`, 'Bootstrap');
}
```

**Status:**
- ‚ùå **No Swagger setup!**
- ‚ùå No DocumentBuilder
- ‚ùå No Swagger UI
- ‚úÖ Global prefix configured

**Swagger URL:** ‚ùå Not available

---

## 2Ô∏è‚É£ Shared Swagger Utilities Analysis

### 2.1 Location: `apps/dashboard-api/src/shared/utils/swagger.util.ts`

**‚ö†Ô∏è Muammo:** Bu fayldan faqat Dashboard API'da foydalanilmoqda. Agent Gateway va Agent API ham foydalana oladi.

### 2.2 Mavjud Decorators

#### 1. `ApiOkResponseData<T>()`
```typescript
ApiOkResponseData<UserResponseDto>(UserResponseDto, {
    body: CreateUserDto,
    summary: 'Create a new user'
})
```
**Maqsadi:** Single object response'larni wrap qilish
**Ishlatilgani:** ‚úÖ Dashboard API controllers

#### 2. `ApiOkResponsePaginated<T>()`
```typescript
ApiOkResponsePaginated<UserResponseDto>(UserResponseDto, {
    summary: 'Get all users'
})
```
**Maqsadi:** Paginated list response'larni wrap qilish
**Ishlatilgani:** ‚úÖ Dashboard API list endpoints

#### 3. `ApiErrorResponses()`
```typescript
ApiErrorResponses({
    forbidden: true,
    notFound: true,
    badRequest: true,
    conflict: true,
})
```
**Maqsadi:** Error response'larni auto-generate qilish
**Ishlatilgani:** ‚úÖ Barcha error response'lar

#### 4. `ApiQueries()`
```typescript
ApiQueries({
    pagination: true,
    search: true,
    sort: true
})
```
**Maqsadi:** Query parameters'ni auto-generate qilish
**Ishlatilgani:** ‚úÖ Filter/search endpoints

#### 5. `ApiOkResponseArray()`
```typescript
ApiOkResponseArray('string', {
    summary: 'Get all user roles'
})
```
**Maqsadi:** Array responses (primitive types)
**Ishlatilgani:** ‚úÖ Simple list endpoints

#### 6. `ApiCrudOperation()` ‚Äì **Combined Decorator** üåü
```typescript
@ApiCrudOperation(UserResponseDto, 'create', {
    body: CreateUserDto,
    summary: 'Create a new user',
    errorResponses: { badRequest: true, conflict: true },
})
```

**Operations:**
- `'create'` ‚Üí POST
- `'update'` ‚Üí PUT
- `'delete'` ‚Üí DELETE
- `'get'` ‚Üí GET by ID
- `'list'` ‚Üí GET list

**Ishlatilgani:** ‚úÖ Most common CRUD endpoints

---

### 2.3 DTO Files

#### `api-response.dto.ts` ‚Äì Dashboard API
```typescript
export class ApiSuccessResponse<T = any> {
    success: boolean;
    message?: string;
    data?: T;
    timestamp: Date;
}

export class ApiErrorResponse {
    success: boolean;
    error?: {
        code: string;
        message: string;
        details?: any;
    };
    timestamp: Date;
}

export class ApiPaginatedResponse<T = any> {
    data: T[];
    total?: number;
    page?: number;
    limit?: number;
}
```

**Status:** ‚úÖ Well-structured, reusable

#### `pagination.dto.ts` ‚Äì Shared Utils
```typescript
export class PaginationDto {
    @ApiProperty({ example: 1, default: 1 })
    @IsOptional()
    @Transform(({ value }) => parseInt(value))
    @IsInt()
    @Min(1)
    page?: number = 1;

    @ApiProperty({ example: 10, default: 10 })
    @IsOptional()
    @Transform(({ value }) => parseInt(value))
    @IsInt()
    @Min(1)
    @Max(100)
    limit?: number = 10;
}

export class PaginationResponseDto<T> {
    @ApiProperty({ isArray: true })
    data: T[];

    @ApiProperty({ example: 100 })
    total?: number;

    @ApiProperty({ example: 1 })
    page?: number;

    @ApiProperty({ example: 10 })
    limit?: number;
}
```

**Status:** ‚úÖ In shared/utils, already reusable

#### `query.dto.ts` ‚Äì Shared Utils
```typescript
export class QueryDto extends PaginationDto {
    @ApiProperty({
        description: 'Search term',
        required: false,
    })
    @IsOptional()
    @IsString()
    @MinLength(2)
    search?: string;

    @ApiProperty({
        description: 'Field to sort by',
        required: false,
    })
    @IsOptional()
    @IsString()
    sort?: string;

    @ApiProperty({
        description: 'Sort order',
        enum: ['asc', 'desc'],
        required: false,
    })
    @IsOptional()
    @IsEnum(SortOrder)
    order?: SortOrder;
}
```

**Status:** ‚úÖ In shared/utils

---

## 3Ô∏è‚É£ Controllers Documentation Coverage

### 3.1 Dashboard API Controllers

```bash
# Total controllers found:
find apps/dashboard-api/src -name "*.controller.ts" -type f
```

#### Controllers List

| Controller | Module | Dokumentatsiya | Status |
|------------|--------|-----------------|--------|
| `user.controller.ts` | User | ‚úÖ Partial | ApiCrudOperation used |
| `organization.controller.ts` | Organization | ‚ùå None | Needs complete docs |
| `department.controller.ts` | Department | ‚ùå None | Needs complete docs |
| `employee.controller.ts` | Employee | ‚ùå None | Needs complete docs |
| `policy.controller.ts` | Policy | ‚ùå None | Needs complete docs |
| `device.controller.ts` | Device | ‚ùå None | Needs complete docs |
| `visitor.controller.ts` | Visitor | ‚ö†Ô∏è Partial | Old implementation |
| `visitors.controller.ts` | Visitors (v2) | ‚ö†Ô∏è Partial | New implementation |
| `app.controller.ts` | App | ‚ùå None | Root endpoint |

#### User Controller ‚Äì Good Example ‚úÖ

```typescript
@ApiTags('Users')
@ApiBearerAuth()
@Controller('users')
@ApiExtraModels(ApiSuccessResponse, UserResponseDto)
export class UserController {
    @Post()
    @ApiCrudOperation(UserResponseDto, 'create', {
        body: CreateUserDto,
        summary: 'Create a new user',
        errorResponses: { badRequest: true, conflict: true },
    })
    async createUser(@Body() createUserDto: CreateUserDto) { }

    @Get()
    @ApiCrudOperation(UserResponseDto, 'list', {
        summary: 'Get all users',
        includeQueries: {
            pagination: true,
            search: true,
            sort: true,
        },
    })
    async getAllUsers(@Query() query: QueryDto) { }

    @Get('me')
    @ApiCrudOperation(UserResponseDto, 'get', {
        summary: 'Get current user',
    })
    async getCurrentUser(@User() user: UserContext) { }

    @Get(':id')
    @ApiParam({ name: 'id', description: 'ID of the user' })
    @ApiCrudOperation(UserResponseDto, 'get', {
        summary: 'Get a specific user by ID',
    })
    async getUserById(@Param('id') id: number) { }
}
```

**‚úÖ Best Practices:**
- ApiTags used correctly
- ApiBearerAuth applied
- ApiCrudOperation for consistency
- Query parameters documented
- Operation-specific summaries

---

### 3.2 Agent API Controllers

**üìç Location:** `apps/agent-api/src/app/modules/`

Controllers bu joyda hozirda qayq ko'rish kerak. Ular dokumentatsiyasiz bo'lishi mumkin.

---

### 3.3 Agent Gateway Controllers

**üìç Location:** `apps/agent-gateway/src/modules/`

Hozirda Swagger setup yo'q, shuning uchun controllers dokumentatsiyasiz.

---

## 4Ô∏è‚É£ DTO Pattern Analysis

### 4.1 Response DTO Pattern

**Standard Response Format:**
```typescript
{
    success: boolean,
    message?: string,
    data?: T,
    timestamp: Date,
    error?: {
        code: string,
        message: string,
        details?: any
    }
}
```

**Implementation:** ‚úÖ Consistent across Dashboard API

### 4.2 Pagination Pattern

**Standard Format:**
```typescript
{
    data: T[],
    total?: number,
    page?: number,
    limit?: number
}
```

**Implementation:** ‚úÖ Consistent

### 4.3 Error Response Pattern

**Standard Format:**
```typescript
{
    success: false,
    error: {
        code: 'ERROR_CODE',
        message: 'Human readable message',
        details?: { additional: 'info' }
    },
    timestamp: Date
}
```

**Implementation:** ‚úÖ In ApiErrorResponse DTO

---

## 5Ô∏è‚É£ Tahlil ‚Äì Qanday O'tkazish Kerak?

### 5.1 Files to Migrate

```
Dashboard API Local Utils ‚Üí Shared Utils Library
‚îÇ
‚îú‚îÄ‚îÄ swagger.util.ts
‚îÇ   ‚îú‚îÄ‚îÄ ApiOkResponseData
‚îÇ   ‚îú‚îÄ‚îÄ ApiOkResponsePaginated
‚îÇ   ‚îú‚îÄ‚îÄ ApiErrorResponses
‚îÇ   ‚îú‚îÄ‚îÄ ApiQueries
‚îÇ   ‚îú‚îÄ‚îÄ ApiOkResponseArray
‚îÇ   ‚îî‚îÄ‚îÄ ApiCrudOperation
‚îÇ
‚îî‚îÄ‚îÄ DTOs (already in shared/utils, just consolidate)
    ‚îú‚îÄ‚îÄ api-response.dto.ts
    ‚îú‚îÄ‚îÄ pagination.dto.ts
    ‚îî‚îÄ‚îÄ query.dto.ts
```

### 5.2 Target Structure

```
shared/utils/src/lib/
‚îú‚îÄ‚îÄ swagger/                          # üÜï NEW FOLDER
‚îÇ   ‚îú‚îÄ‚îÄ swagger.util.ts              # Moved
‚îÇ   ‚îú‚îÄ‚îÄ auth-decorators.ts           # üÜï For ApiSecureOperation, etc
‚îÇ   ‚îú‚îÄ‚îÄ file-decorators.ts           # üÜï For file upload docs
‚îÇ   ‚îú‚îÄ‚îÄ pagination-helpers.ts        # üÜï For ApiPaginatedGet
‚îÇ   ‚îú‚îÄ‚îÄ error-responses.ts           # üÜï For error handling
‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îî‚îÄ‚îÄ __tests__/
‚îÇ       ‚îî‚îÄ‚îÄ swagger.util.spec.ts
‚îÇ
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ api-response.dto.ts
‚îÇ   ‚îú‚îÄ‚îÄ pagination.dto.ts
‚îÇ   ‚îú‚îÄ‚îÄ query.dto.ts
‚îÇ   ‚îú‚îÄ‚îÄ swagger/                     # üÜï Swagger-specific DTOs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api-error.dto.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api-success.dto.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ
‚îú‚îÄ‚îÄ index.ts                          # Export all
‚îî‚îÄ‚îÄ README.md                         # Usage guide
```

### 5.3 Import Changes Needed

**Hozir:**
```typescript
// apps/dashboard-api
import { ApiCrudOperation } from '../../shared/utils/swagger.util';
```

**Keyin:**
```typescript
// apps/dashboard-api
import { ApiCrudOperation } from '@app/shared/utils';

// apps/agent-api
import { ApiCrudOperation } from '@app/shared/utils';

// apps/agent-gateway
import { ApiCrudOperation } from '@app/shared/utils';
```

---

## 6Ô∏è‚É£ Qo'shimcha Utilities ‚Äì Keyin Qo'shish Kerak

### 6.1 Auth Decorators

**Tavsiya etilgan naming:**
```typescript
// shared/utils/src/lib/swagger/auth-decorators.ts

export const ApiSecureOperation = (roles?: Role[]) => applyDecorators(
    ApiBearerAuth(),
    ApiUnauthorizedResponse({ description: 'Missing or invalid token' }),
    ...(roles ? [ApiForbiddenResponse({ description: 'Insufficient permissions' })] : [])
);

export const ApiKeySecureOperation = () => applyDecorators(
    ApiSecurity('api-key'),
    ApiBadRequestResponse({ description: 'Missing API key' })
);

export const ApiPublicOperation = () => applyDecorators(
    ApiOperation({ summary: 'Public endpoint' })
);
```

### 6.2 File Upload Decorators

```typescript
// shared/utils/src/lib/swagger/file-decorators.ts

export const ApiFileUpload = (
    fieldName: string = 'file',
    options?: { 
        mimetype?: string; 
        maxSize?: number 
    }
) => applyDecorators(
    ApiConsumes('multipart/form-data'),
    ApiBody({
        schema: {
            type: 'object',
            properties: {
                [fieldName]: {
                    type: 'string',
                    format: 'binary',
                    description: options?.mimetype || 'File to upload'
                },
            },
        },
    })
);

export const ApiMultipleFileUpload = (
    fieldName: string = 'files',
    maxFiles: number = 10
) => applyDecorators(
    ApiConsumes('multipart/form-data'),
    ApiBody({
        schema: {
            type: 'object',
            properties: {
                [fieldName]: {
                    type: 'array',
                    items: { type: 'string', format: 'binary' },
                    maxItems: maxFiles
                },
            },
        },
    })
);
```

### 6.3 Pagination Helper

```typescript
// shared/utils/src/lib/swagger/pagination-helpers.ts

export const ApiPaginatedGet = <T extends Type<unknown>>(
    dataDto: T,
    options?: { 
        summary?: string; 
        search?: boolean; 
        filters?: Record<string, Type>
    }
) => applyDecorators(
    ApiOperation({ summary: options?.summary || 'Get paginated list' }),
    ApiQueries({ 
        pagination: true, 
        search: options?.search || false,
        filters: options?.filters || {}
    }),
    ApiOkResponsePaginated(dataDto),
    ApiErrorResponses({
        unauthorized: true,
        forbidden: true,
    })
);
```

---

## 7Ô∏è‚É£ Endpoint Documentation Strategy

### 7.1 Dashboard API ‚Äì Required Documentations

| Module | Endpoints | Priority | Status |
|--------|-----------|----------|--------|
| **Users** | 6-8 | üî¥ HIGH | ‚úÖ DONE |
| **Organizations** | 5-7 | üî¥ HIGH | ‚ùå TODO |
| **Departments** | 6-8 | üî¥ HIGH | ‚ùå TODO |
| **Employees** | 8-10 | üî¥ HIGH | ‚ùå TODO |
| **Policies** | 5-7 | üü° MEDIUM | ‚ùå TODO |
| **Devices** | 5-6 | üü° MEDIUM | ‚ùå TODO |
| **Visitors** | 6-8 | üü° MEDIUM | ‚ö†Ô∏è PARTIAL |

**Total Endpoints:** ~45-60
**Currently Documented:** ~6 (User controller)
**Coverage:** ~10%

### 7.2 Agent API ‚Äì Required Documentations

| Module | Endpoints | Priority | Status |
|--------|-----------|----------|--------|
| **Ingest** | 3-5 | üî¥ HIGH | ‚ùå TODO |
| **Gateway Control** | 4-6 | üî¥ HIGH | ‚ùå TODO |
| **Health** | 1-2 | üü° MEDIUM | ‚ùå TODO |

**Total Endpoints:** ~8-13
**Currently Documented:** 0
**Coverage:** 0%

### 7.3 Agent Gateway ‚Äì Required Documentations

| Module | Endpoints | Priority | Status |
|--------|-----------|----------|--------|
| **Health** | 1-2 | üü° MEDIUM | ‚ùå TODO |
| **Collector** | 2-3 | üî¥ HIGH | ‚ùå TODO |
| **Uplink** | 2-3 | üü° MEDIUM | ‚ùå TODO |
| **Device** | 3-5 | üî¥ HIGH | ‚ùå TODO |
| **Buffer** | 1-2 | üü° MEDIUM | ‚ùå TODO |

**Total Endpoints:** ~9-15
**Currently Documented:** 0
**Coverage:** 0%

---

## 8Ô∏è‚É£ Package Dependencies

### Currently Used
```json
{
  "@nestjs/common": "^11.1.6",
  "@nestjs/swagger": "^11.2.0",
  "class-validator": "^0.14.2",
  "class-transformer": "^0.5.1"
}
```

### Additional Needed (Optional)
```json
{
  "@nestjs/platform-express": "^11.x",  // For file uploads
  "swagger-ui-dist": "^5.21.0"          // Already installed
}
```

---

## 9Ô∏è‚É£ Files to Create/Modify

### Create (New)
```
shared/utils/src/lib/swagger/
‚îú‚îÄ‚îÄ swagger.util.ts              (move from dashboard-api)
‚îú‚îÄ‚îÄ auth-decorators.ts           (new)
‚îú‚îÄ‚îÄ file-decorators.ts           (new)
‚îú‚îÄ‚îÄ pagination-helpers.ts        (new)
‚îú‚îÄ‚îÄ error-responses.ts           (new)
‚îú‚îÄ‚îÄ __tests__/
‚îÇ   ‚îú‚îÄ‚îÄ swagger.util.spec.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth-decorators.spec.ts
‚îÇ   ‚îî‚îÄ‚îÄ file-decorators.spec.ts
‚îú‚îÄ‚îÄ index.ts                     (new)
‚îî‚îÄ‚îÄ README.md                    (new)

shared/utils/src/lib/dto/swagger/
‚îú‚îÄ‚îÄ api-error.dto.ts             (move/consolidate)
‚îú‚îÄ‚îÄ api-success.dto.ts           (move/consolidate)
‚îî‚îÄ‚îÄ index.ts                     (new)
```

### Modify
```
apps/dashboard-api/src/
‚îú‚îÄ‚îÄ main.ts                      (no change needed)
‚îú‚îÄ‚îÄ shared/utils/                (remove swagger.util.ts)
‚îî‚îÄ‚îÄ modules/**/*.controller.ts   (add missing docs)

apps/agent-api/src/
‚îú‚îÄ‚îÄ main.ts                      (add Swagger if missing)
‚îî‚îÄ‚îÄ modules/**/*.controller.ts   (add docs)

apps/agent-gateway/src/
‚îú‚îÄ‚îÄ main.ts                      (ADD Swagger setup)
‚îî‚îÄ‚îÄ modules/**/*.controller.ts   (add docs)

shared/utils/src/
‚îú‚îÄ‚îÄ lib/index.ts                 (update exports)
‚îî‚îÄ‚îÄ package.json                 (no change needed)
```

---

## üîü Execution Order

1. **Create shared swagger directory structure**
2. **Move swagger.util.ts from dashboard-api**
3. **Update dashboard-api imports**
4. **Create additional decorators**
5. **Add Swagger to Agent Gateway main.ts**
6. **Update Agent API Swagger setup**
7. **Document all controllers (dashboard-api first)**
8. **Document Agent API controllers**
9. **Document Agent Gateway controllers**
10. **Write comprehensive README**

---

## 1Ô∏è‚É£1Ô∏è‚É£ Risk Factors

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|-----------|
| Import cycles | Medium | High | Module structure review |
| Missing exports | High | Low | Export tests |
| Breaking changes | Medium | High | Beta branch + tests |
| Performance hit | Low | Medium | Lazy loading |

---

## 1Ô∏è‚É£2Ô∏è‚É£ Success Criteria

‚úÖ 100% endpoints documented in Swagger
‚úÖ All DTOs use @ApiProperty decorators
‚úÖ Shared utilities exported from @app/shared/utils
‚úÖ Zero duplicate Swagger code
‚úÖ All three apps use shared decorators
‚úÖ Swagger UI loads <2 seconds
‚úÖ Documentation matches implementation
‚úÖ All examples include realistic data

---

**Prepared:** 2025-10-17
**Status:** Analysis Complete ‚Äì Ready for Implementation
